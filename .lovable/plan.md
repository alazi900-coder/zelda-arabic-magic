

# حفظ النصوص الأصلية ومنع فقدانها عند إعادة الاستخراج

## المشكلة
عند بناء ملف BDAT عربي ثم إعادة استخراج النصوص منه، يظهر النص العربي المُشكَّل (Presentation Forms) كنص "أصلي" بدلاً من الإنجليزي. هذا يمنع المستخدم من مراجعة وتحسين الترجمات لأنه فقد المرجع الأصلي.

## السبب التقني
- عملية البناء (patchBdatFile) تستبدل النصوص الإنجليزية بالعربية المُشكَّلة في الملف الثنائي
- عند إعادة الاستخراج، المحلل (bdat-parser) يقرأ النص العربي كنص "أصلي"
- النص يظهر معكوساً لأنه مُعالج بـ Presentation Forms + BiDi Reversal

## الحل المقترح (3 أجزاء)

### 1. حفظ النصوص الأصلية في IndexedDB بشكل منفصل
- عند أول استخراج من ملف BDAT أصلي (إنجليزي)، حفظ قاموس `originalTexts` منفصل في IndexedDB
- المفتاح: `bdat-bin:filename:table:row:col` والقيمة: النص الإنجليزي الأصلي
- هذا القاموس لا يتغير أبداً عند البناء أو إعادة الاستخراج

### 2. كشف إعادة الاستخراج من ملف مبني
- عند استخراج نصوص جديدة، فحص إذا كانت النصوص تحتوي على Presentation Forms عربية (U+FB50-U+FDFF, U+FE70-U+FEFF)
- إذا اكتُشفت، عرض تنبيه واضح: "يبدو أنك تستخرج من ملف مبني سابقاً. النصوص الأصلية محفوظة — هل تريد استعادتها؟"
- عند الموافقة: استبدال حقل `original` في كل إدخال بالنص المحفوظ من القاموس الأصلي

### 3. إضافة زر "استعادة النصوص الأصلية" في المحرر
- زر واضح في شريط الأدوات يتيح للمستخدم استبدال النصوص "الأصلية" الحالية بالنسخ الإنجليزية المحفوظة
- مفيد إذا أغلق التنبيه بالخطأ أو أراد التبديل لاحقاً

## التفاصيل التقنية

### الملفات المتأثرة:

**`src/pages/XenobladeProcess.tsx`**
- بعد الاستخراج الناجح، حفظ `originalTexts` في IndexedDB عبر `idbSet("originalTexts", map)`
- فحص إذا كانت النصوص المستخرجة تحتوي Presentation Forms عربية

**`src/hooks/useEditorState.ts`**
- عند تحميل الحالة، التحقق من وجود `originalTexts` في IndexedDB
- إضافة دالة `restoreOriginals()` تستبدل `entry.original` بالقيم المحفوظة
- إضافة كشف تلقائي: إذا كانت النصوص الحالية عربية مُشكَّلة ويوجد أصل إنجليزي محفوظ، عرض تنبيه

**`src/lib/idb-storage.ts`**
- إضافة مفتاح `originalTexts` لتخزين القاموس الأصلي

**`src/components/editor/types.tsx`**
- إضافة دالة `hasPresentationForms(text)` لكشف النصوص المُشكَّلة (Presentation Forms-B range)

**`src/pages/Editor.tsx`**
- إضافة زر "استعادة الأصل الإنجليزي" في شريط الأدوات عند اكتشاف نصوص أصلية عربية

### منطق الكشف:
```text
function hasPresentationForms(text: string): boolean
  -- يفحص إذا النص يحتوي حروف من نطاق Presentation Forms-B
  -- (U+FE70 - U+FEFF) التي تُنتج من عملية الـ Reshaping
  -- وجود هذه الحروف في "الأصل" يعني أن الملف مبني سابقاً
```

### تدفق العمل بعد التحسين:
```text
1. المستخدم يستخرج من ملف BDAT أصلي
   --> يتم حفظ النصوص الإنجليزية في "originalTexts"

2. المستخدم يترجم ويبني ملف BDAT عربي
   --> الملف المبني يحتوي نصوص عربية مُشكَّلة

3. المستخدم يعيد استخراج من الملف المبني
   --> النظام يكتشف Presentation Forms في النصوص
   --> يعرض تنبيه: "ملف مبني سابقاً — استعادة الأصل؟"
   --> عند الموافقة: يستبدل الأصل بالإنجليزي المحفوظ
   --> الترجمات السابقة تبقى كما هي
```
