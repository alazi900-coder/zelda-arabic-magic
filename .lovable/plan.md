
# خطة الإصلاح الشامل: القواميس + البناء + التشخيص

## المشاكل المكتشفة

### 1. مشكلة القاموس الكبير (xc3-ui-menus-glossary.txt) — حرجة
ملف القاموس الكبير (3571 سطر) يحتوي على مشاكل هيكلية خطيرة تسبب الفشل الصامت في الترجمة:

- **مسافات زائدة في نهاية الترجمات**: كل سطر تقريباً ينتهي بمسافة فارغة مثل `Bronze Temple Guard=حارس المعبد البرونزي  ` — مما يجعل الترجمة تُرسل للعبة مع مسافة إضافية قد تتجاوز حد البايت
- **أسطر طويلة جداً كمفتاح**: مثل جمل كاملة بها كلمات متعددة كمفتاح `=` — هذا صحيح من ناحية القاموس، لكن لا تطابق أبداً في BDAT لأن مفاتيح البحث في القاموس تعمل على النص الكامل
- **رموز تقنية كمفتاح**: سطور مثل `#[ML:number ]=#[ML:number ]` و `+=+` — هذه رموز برمجية تُحفظ في القاموس وتستهلك ذاكرة بدون فائدة لأنها لن تُترجَم أبداً عبر القاموس
- **الأسطر الفارغة من القراءة**: دالة `parseGlossaryMap` تعمل بشكل صحيح لكن المسافات الزائدة في القيم لا تُنظَّف

**التأثير**: عند تطبيق القاموس على الترجمة، تُضاف مسافات في نهاية كل ترجمة → تتجاوز حد البايت → تُتخطى عند البناء → النص يختفي في اللعبة!

### 2. مشكلة الحفظ التلقائي — متوسطة
- `AUTOSAVE_DELAY` غير معروف القيمة من هنا، والحفظ يستند إلى `state?.translations` فقط
- عند بدء البناء، يُحتمل وجود **race condition**: الحفظ التلقائي قد يكون لم ينتهِ بعد حين يقرأ `handleBuild` البيانات من IDB
- لا يوجد حفظ **فوري** (force-save) قبل البناء — البناء يقرأ من `state` في الذاكرة وليس من IDB، لكن الترجمات المؤقتة قد تفوت

### 3. نافذة تأكيد البناء — تحتاج تحسين
- لا تُظهر تحذيرات مشاكل الجودة (overflow، رموز مفقودة، معالجة عربية ناقصة)
- لا تُظهر عدد ملفات BDAT التي ستتأثر
- لا يوجد مؤشر على الملفات غير المرفوعة

### 4. غياب أداة التشخيص قبل البناء
لا توجد أداة تفحص حالة البيانات قبل البناء وتُنبّه المستخدم بمشاكل محتملة.

---

## خطة الإصلاح

### أولاً: إصلاح القواميس (الأهم)

**`src/hooks/useEditorGlossary.ts`** — تحسين `parseGlossaryMap`:
- إضافة `.trim()` على القيمة العربية (وليس المفتاح فقط)
- هذا يحل مشكلة المسافات الزائدة في نهاية الترجمات من القاموس الكبير

**`public/xc3-ui-menus-glossary.txt`** — تنظيف الملف:
- إزالة المسافات الزائدة من نهاية جميع أسطر الترجمة
- حذف السطور التي تحتوي على رموز تقنية خالصة كمفاتيح (`#[ML:...]`, `+=+`, `-= -`, إلخ) لأنها عديمة الفائدة في القاموس

### ثانياً: إصلاح الحفظ التلقائي

**`src/hooks/useEditorState.ts`** — تحسين منطق الحفظ:
- إضافة **حفظ فوري** (force-save) يُستدعى مباشرة قبل بدء البناء
- استخدام `useRef` لتتبع أحدث قيمة للترجمات (حل stale closure)
- إضافة مؤشر "جاري الحفظ..." في الواجهة أثناء الحفظ

**`src/hooks/useEditorBuild.ts`**:
- إضافة خطوة `await forceSave()` كأول خطوة في `handleBuildXenoblade` قبل قراءة البيانات

### ثالثاً: تحسين نافذة تأكيد البناء

**`src/components/editor/BuildConfirmDialog.tsx`** — إضافة:
- قسم **"تحذيرات ما قبل البناء"** يُظهر:
  - عدد الترجمات التي تتجاوز حد البايت (overflow)
  - عدد النصوص العربية غير المعالجة (بدون presentation forms)
  - هل هناك ملفات BDAT مرفوعة؟ أم Demo data فقط؟
- عدد ملفات BDAT التي ستتأثر بالبناء

**`src/hooks/useEditorBuild.ts`** — تحسين `handlePreBuild`:
- حساب إحصائيات التحذيرات وتمريرها للـ Dialog

### رابعاً: إضافة أداة التشخيص قبل البناء

**ملف جديد: `src/components/editor/PreBuildDiagnostic.tsx`**:
أداة تشخيصية شاملة تُعرض كـ Dialog قبل البناء، تفحص:
1. ✅/❌ هل البيانات من Demo أم ملفات حقيقية؟
2. ✅/❌ عدد الترجمات الكاملة مقابل الناقصة
3. ✅/❌ النصوص العربية غير المعالجة (تحتاج Reshaping)
4. ✅/❌ الترجمات التي تتجاوز حد البايت (ستُتخطى في البناء)
5. ✅/❌ الرموز التقنية المفقودة من الترجمات
6. ✅/❌ هل الحفظ الأخير كان قبل أقل من دقيقة؟

الأداة تعطي تقييماً عاماً: **"جاهز للبناء"** أو **"يوجد تحذيرات"** أو **"توقف — مشاكل حرجة"**.

---

## الملفات التي ستتعدل

| الملف | التغيير |
|---|---|
| `src/hooks/useEditorGlossary.ts` | إضافة `.trim()` على القيم في `parseGlossaryMap` |
| `public/xc3-ui-menus-glossary.txt` | إزالة المسافات الزائدة من جميع الترجمات |
| `src/hooks/useEditorState.ts` | إضافة `forceSave` ref وتمريرها للـ build hook |
| `src/hooks/useEditorBuild.ts` | استدعاء forceSave قبل البناء + إضافة بيانات تحذيرات للـ preview |
| `src/components/editor/BuildConfirmDialog.tsx` | إضافة قسم التحذيرات والإحصائيات المفصلة |
| `src/components/editor/PreBuildDiagnostic.tsx` | ملف جديد — أداة التشخيص الشاملة |

---

## ترتيب التنفيذ

1. إصلاح القاموس (الأهم — يحل مشكلة المسافات الزائدة)
2. إصلاح `parseGlossaryMap` (يضمن نظافة القيم)
3. إضافة `forceSave` قبل البناء (يحل race condition)
4. تحسين `BuildConfirmDialog` بالتحذيرات
5. إنشاء `PreBuildDiagnostic` وربطه بزر البناء
