
الهدف الآن: تحويل القاموس من “مرجع ضعيف” إلى “مرجع مُلزِم فعلياً” أثناء الترجمة، حتى يظهر أثره مباشرة في النتائج بدل الإحساس أنه غير مستخدم.

ملخص ما وجدته في الكود (سبب المشكلة):
1) القاموس يعمل حالياً بثلاث طبقات، لكن الطبقة الأقوى ليست إلزامية:
- مطابقة مباشرة (Exact match) فقط عندما يكون النص بالكامل مطابقاً لمفتاح القاموس.
- إرسال “مصطلحات مرتبطة فقط” إلى الذكاء الاصطناعي (وليس القاموس كاملاً) — وهذا ظاهر في السجلات: أحياناً 16 أو 109 مصطلح فقط لكل دفعة.
- استبدال لاحق للكلمات الإنجليزية التي تبقى بعد الترجمة.
2) إذا قام الذكاء الاصطناعي بترجمة المصطلح بشكل عربي مختلف (وليس إنجليزي متبقٍ)، فلن تلتقطه المعالجة اللاحقة؛ لذلك يبدو أن القاموس “لم يفد”.
3) رسالة الذكاء الاصطناعي الحالية في الدالة تشير إلى Zelda بدل Xenoblade، وهذا يضعف الانضباط المصطلحي في هذا المشروع.
4) الواجهة لا تعرض أرقام واضحة: كم نص ترجم من القاموس مباشرة؟ كم مصطلح فُرض بالقوة؟ كم أُرسل سياقياً؟ فيصير من الصعب رؤية الفائدة.

ما سأطبقه لإصلاح المشكلة نهائياً:
1) طبقة “قفل المصطلحات” الإلزامية (Term Locking) داخل الترجمة
- قبل إرسال النص للذكاء الاصطناعي، سأبحث داخل كل جملة عن مصطلحات القاموس المطابقة.
- أستبدلها مؤقتاً برموز ثابتة غير قابلة للترجمة.
- بعد رجوع الترجمة، أعيد هذه الرموز إلى الترجمة العربية المعتمدة من القاموس.
- النتيجة: أي مصطلح موجود في الجملة سيخرج بالترجمة المعتمدة 100%، وليس اقتراحاً.

2) تحسين مطابقة المصطلحات داخل الجمل
- دعم أفضل للحدود (word boundaries) والرموز الخاصة والشرطات.
- معالجة التداخل بين المصطلحات (longest-first) حتى لا يلتقط مصطلح قصير جزءاً من مصطلح أطول.
- تقليل الإيجابيات الكاذبة للمفاتيح القصيرة جداً.

3) تقوية توجيه نموذج الذكاء الاصطناعي
- تحديث Prompt ليكون خاصاً بـ Xenoblade Chronicles 3.
- إضافة قاعدة صريحة: “إذا كان هناك مصطلح من القاموس فلا يجوز تغييره”.
- إبقاء حماية الوسوم التقنية كما هي.

4) شفافية كاملة داخل الواجهة (حتى ترى فائدة القاموس بالأرقام)
- إضافة مؤشرات تفصيلية تظهر بعد كل دفعة:
  - عدد المطابقات المباشرة من القاموس.
  - عدد المصطلحات التي فُرضت عبر Term Lock.
  - عدد المصطلحات السياقية المرسلة للموديل.
- تحديث رسالة الحالة الحالية بدل عرض رقم واحد عام.

5) اختبارات ومنع تكرار المشكلة
- إضافة اختبارات لوظائف:
  - parsing القاموس.
  - استخراج المصطلحات المرتبطة.
  - term locking / unlock.
  - حالات التداخل والرموز الخاصة.
- اختبار E2E عملي على دفعة حقيقية من نصوص الشخصيات/القتال/الحوارات للتحقق أن المصطلحات تخرج موحّدة.

الملفات المستهدفة بالتعديل:
- supabase/functions/translate-entries/index.ts
- src/hooks/useEditorTranslation.ts
- src/hooks/useEditorState.ts (إذا احتجنا توسيع بنية الإحصاءات)
- src/pages/Editor.tsx (عرض مؤشرات استخدام القاموس)

ترتيب التنفيذ:
1) تنفيذ Term Locking في backend.
2) تحديث prompt وقواعد الإلزام.
3) إرجاع إحصاءات الاستخدام مع الاستجابة.
4) عرض الإحصاءات في الواجهة.
5) تشغيل اختبارات الحالات الحرجة والتحقق النهائي على عينة كبيرة.

معيار النجاح بعد التنفيذ:
- المصطلحات الموجودة في القاموس تظهر فعلياً في النصوص المترجمة بشكل موحّد.
- المستخدم يرى بالأرقام في كل تشغيل أن القاموس استُخدم فعلاً.
- اختفاء الانطباع أن القاموس “كبير لكن غير مفيد” لأن التأثير سيصبح واضحاً في النتيجة وفي الإحصاء.
