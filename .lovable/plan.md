

# اصلاح المحلل لدعم ملفات الحوارات (msg_*.bdat)

## المشكلة
ملفات الحوارات مثل `msg_ask110001.bdat` و `msg_ev01005100.bdat` لا تُستخرج منها النصوص بشكل صحيح. المحلل الحالي يحتوي على عدة أخطاء عند مقارنته بالتطبيق المرجعي (bdat-rs).

## الحل
اصلاح 3 أخطاء في `src/lib/bdat-parser.ts` واضافة تشخيصات محسنة:

## التفاصيل التقنية

### الاصلاح 1: قراءة أسماء الأعمدة (Bug الأساسي)
المحلل الحالي يقرأ هاشات أسماء الأعمدة من جدول الصفوف (hashTableOffset) بدلاً من جدول النصوص (stringTableOffset). هذا يطابق بيانات خاطئة تماماً.

**الحالي:**
```
hashOffset = hashTableOffset + nameRef * 4
```

**الصحيح (من bdat-rs):**
```
hashOffset = stringTableOffset + 1 + nameRef
```

### الاصلاح 2: قراءة اسم الجدول
المحلل يقرأ هاش اسم الجدول من `stringTableOffset + 1` بينما bdat-rs يقرأه من `stringTableOffset + 2`.

### الاصلاح 3: كشف نوع الترويسة
نظام الكشف التلقائي (u16 vs u32) يفشل لبعض الملفات. بما أن XC3 يستخدم دائماً ترويسة 48 بايت (u32)، سنضيف التحقق من نسخة الجدول (0x3004) لتأكيد النوع بدلاً من الاعتماد على الاستدلال.

### الاصلاح 4: تشخيصات محسنة
اضافة سجل تفصيلي في `XenobladeProcess.tsx` يعرض:
- عدد الأعمدة وأنواعها لكل جدول
- عدد أعمدة String vs MessageId vs أنواع أخرى
- عينة من القيم المقروءة من كل جدول

### الملفات المتأثرة
1. **`src/lib/bdat-parser.ts`** - اصلاح الأخطاء الثلاثة
2. **`src/pages/XenobladeProcess.tsx`** - تحسين التشخيصات
3. **`src/lib/bdat-writer.ts`** - التأكد من توافق الكاتب مع الاصلاحات

